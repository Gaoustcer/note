# Network layer -- HIT

## 网络层概述

### 基本任务

* 实现主机与主机之间的通信
* 发送主机：将数据段封装到数据报中
* 接收主机：向传输层交付数据段
* 每个主机和服务器都运行网络层协议
* 路由器检验所有穿越它的IP数据报头部域

### 网络层核心功能-转发和路由

* 转发：分组从路由器输入端口转移到合适的输出端口（转发表）
* 路由：确定分组从源到目的经过的路径（路由算法/协议）
* 连接建立
  * 只是属于某些网络
  * 数据分组传输之前建立虚拟/逻辑连接
  * 网络设备参与连接的建立
  * 端到端的传输层连接对于中间主机是透明的
* 网络为网络层提供了什么服务模型？
  * 尽力传输（Internet）
  * CBR/VNR/ABR/UBR

### 网络层服务模型

* 无连接服务
  * 不事先为系列分组确定传输路径
  * 每个分组可能传输路径不同
  * 每个分组传输路径不同
  * 数据报网络
* 连接服务
  * 首先为系列分组传输确定源到目的经过的路径，建立连接
  * 虚电路网络

## 虚电路网络

* 主机到主机的服务
* 网络核心实现

### 虚电路

一条源主机到目的主机的类似于电路的路径，是逻辑连接

* 分组交换
* 每个分组传输利用全部带宽

### 通信过程

* 呼叫建立 分配虚电路VCID
* 数据传输
* 拆除呼叫

携带相同vcid的分组走相同的路径，分组携带的不是目的地址

### VC的实现

* 路径
* 虚电路号

### 虚电路信令协议

* 用于VC建立维护和拆除
  * 路径选择
* 适用于虚电路网络
* 初始呼叫-呼叫到达-接受呼叫-呼叫建立-传输数据-连接拆除

## 数据报网络

* 网络层无连接
* 每个分组携带目的地址
* 路由器根据目的地址转发
  * 路由算法构建转发表
  * 检索转发表
  * 每个分组独立选路，一次传输中不同分组传输路径可能不同
  * Internet网络，地址指的是IP地址，32位二进制数-不可能存储所有IP

### 转发表 -最长前缀匹配原则

减少转发表开销-（目的IP范围，输出链路）

连续地址划分

非连续地址划分：前缀比对确定转发目标，无法匹配选择缺省路由 

一个地址在多个范围内，满足最长前缀匹配

用于匹配的地址（前缀）越小，满足的地址范围越大

### 对比-数据报网络 && VC网络

#### 数据报网络

* 计算机之间的数据交换
  * 弹性服务，没有严格的时间要求
* 链路类型众多
  * 特点，性能各异
  * 统一服务困难
  * 跨网络通信
* “智能”端系统
  * 可以自适应，性能控制，差错恢复
  * 简化网络，复杂边缘

#### VC网络

* 电话网络演化而来
* 核心业务是实时对话
  * 严格的时间、可靠性需求
  * 有保障的服务
* dumb端系统
  * 电话机、传真机
  * 简化边缘，复杂网络

## IPv4协议

### 主要功能

* 路由
  * 路由协议
* 转发表
  * IP协议
    * 怎样寻址
    * 数据报格式
    * 数据报处理
* ICMP协议
  * 差错报告
  * 路由器信令

### IPv4数据报结构

#### 首部

##### 固定部分20byte

* 版本号：IP协议版本，4bit
* 首部长度：4bit->头部长度超过？**以四字节为单位**，首部长度$\times$4=实际的首部长度
* 服务类型：8bit
  * 最初指示期望获得何种服务
  * 区分服务：优先转发
  * 前提是网络提供区分服务
  * 一般取0
* 总长度：16bit，最大65535byte，首部+数据
* 生存时间TTL：8bit，标识IP分组在网络中可以通过的路由器数(跳步数)
  * 路由器每经过一次转发，TTL-1
  * TTL=0，路由器丢弃该分组，并向源主机发送ICMP报文
  * **可以防止数据包环路**
  * 协议号（Protocol），端口号（Port），类型值（Type）
* 协议字段，指示封装的**上层协议**是什么，TCP/UDP
  * 复用、分解
  * 调用适合的上层协议处理数据报
* 首部校验和：实现对IP分组首部的差错检测
  * 每次转发重新计算，重新校验
  * UDP相同
* 源，目的IP地址，各32bit
* DSF(服务区分符)：确保被优先转发

##### 可变部分（1-40B）

很少被使用

##### 填充域

保证首部长度为4字节的倍数

#### 数据

### IP分片

#### 最大传输单元

网络层产生的数据报在链路层被封装为数据帧

MTU：最大传输单元，代表链路层可以封装数据的上限

MTU和链路有关，MTU不匹配

#### 分片与重组

大的IP分组向较小的MTU转发，**可以**被分片

* 一个IP分组被分为多片IP分组-fragmented
* IP分组到达**目的主机**后进行重组-reassembled

IP首部的字段参与标识分片和分片的相对顺序

* IP总长度，标识，标志位，片偏移

#### 标识字段

16bit

每产生一个IP字段，标识+1

结合源主机，目的主机判断

#### 标志位字段

保留+DF(Don't Fragment)+MF(more fragment)

* DF=1,禁止分片 DF=0 允许分片
* MF=1，不是最后一片，MF=0，最后一片（或没分片）

#### 片偏移字段

13bit

一个IP分组分片封装原来IP分组数据的相对偏移量

以8字节为单位-首部长度，除了最后一片，一定是8的倍数

#### IP分片过程

原分组长度为L，转发链路MTU为M

* L>M而且DF=0,则可以、需要分片
* 每个分片保留原分组标识
* 除了最后一个分片，其它分片大小均是MTU而且是8的倍数

### IP编址

#### IP数据报的地址

* 源地址
* 目的地址

#### 接口：主机/路由器与物理链路的连接

* 实现网络层功能
* 路由器多个接口
* 主机一个或两个接口

#### 网络层的IP编制

##### IP地址

32bit二进制数，表示主机、路由器的**接口**

点分十进制IP地址

IP接口与接口相关联，对于主机，就是主机的IP地址

##### 分配IP地址的规则

* 分段
  * 网络号-高位比特
  * 主机号-低位比特
* 具有相同网络好的接口称为IP子网，在同一个输出链路上
  * 不跨越路由器设备可以彼此物理联通
  * IP子网地址

### 有类IP地址

网络号+主机号=32bit

#### 有类编址-对IP地址进行人为划分

* A类地址，0.0.0.0-127.255.255.255 32位比特以0开头  NetID 8bits HostID 24bits，实际可用的网络号为7位
* B类地址 128.0.0.0-191.255.255.255 32位比特以10开头 NetID 16bits HostID 16bits，实际可用的网络号位14
* C类地址，32位比特位110开头 NetID 24bits HostID 8bits，实际可用的网络号21位
* D，1110 全部为网络号 D标识一组主机，只能作为目的主机，实际可用网络号为28，只能作为发送地址，多播地址
* E,1111 全部为网络号 保留

A，B，C均带有网络号和主机号，用于标识网络中的主机和接口

缺点，不灵活

#### 特殊的IP地址

| NetID  | HostID | 作为IP分组源地址 | 作为IP分组目的地址 | 用途                                                         |
| ------ | ------ | ---------------- | ------------------ | ------------------------------------------------------------ |
| 全0    | 全0    | 可以             | 不可以             | 本网范围内表示本机，路由表中表示默认路由                     |
| 全0    | 特定值 | 不可以           | 可以               | 子网内的某个特定主机                                         |
| 全1    | 全1    | 不可以           | 可以               | 广播地址，路由器不转发，在本网当中向本网广播                 |
| 特定值 | 全0    | 不可以           | 不可以             | 网络地址，表示一个网络，保证一个子网内所有主机网络地址相同   |
| 特定值 | 全1    | 不可以           | 可以               | 直接广播地址，对特定网络上的所有主机进行广播，发送的目的和源主机不在同一个子网中 |
| 127    | 任何数 | 可以             | 可以               | 环回地址，IP分组不会离开这个主机                             |

#### 私有的IP地址

仅用于内部网络，路由器对这些IP的数据报不转发

| class | NetIDs                | Block |
| ----- | --------------------- | ----- |
| A     | 10                    | 1     |
| B     | 172.16-172.31         | 16    |
| C     | 192.168.0-192.168.255 | 256   |

### IP子网划分

#### 进一步划分IP地址，子网的子网

* 网络号
* 子网号（来自于主机号域）
* 主机号

目的：隔离通信流量，解决有类编址不灵活的情况

问题：确定是否划分了子网以及多少位划分子网，划分子网并用不同接口转发，更行路由表

#### 子网掩码-确定子网划分的程度

32bit二进制数，点分十进制

NetID,SubID全取1，HostID全取0

子网地址+子网掩码确定子网大小

A,B,C类默认子网掩码就是对应的NetID全为1

子网地址+子网掩码确定转发

#### 子网掩码的应用

IP分组目的地址与子网掩码按位与运算，提取子网地址

可分配地址范围：一个子网内地址范围初去默认分配

划分子网会造成地址浪费

## CIDR

* 目的：消除地址分类
  * NetID+SubID为网络前前缀

* 融合网络地址和子网掩码
  * 无类地址格式 a.b.c.d/x x为前缀长度
* 有点
  * 提高Ipv4地址空间分配效率
  * 提高路由效率
    * 多个子网聚合成较大的子网
    * 超网
    * 路由聚合，减少路由表中表项数目

