# Computer Network-数据链路层 HIT

## 术语

* 主机+路由器：结点
* 连接相邻链路的通信信道：链路
* 链路层数据分组：帧，封装网络层数据报

## 链路层服务

### 组帧

* 封装数据报为数据帧，加头尾
* 帧同步：从数据流中识别出一个数据帧
  * 首尾增加特定字符
  * 避免和数据产生歧义

### 链路接入

* 共享介质，解决信道接入
* 多个结点通过同一链路传输数据
* MAC地址(物理地址)，用于标识源和目的帧
  * 不同于MAC地址

### 相邻结点可靠传输

* 取决于有线链路的误码率
* 无线链路需要可靠交付，确认-重传

### 流量控制与差错检测，差错纠正

* 协调相邻节点的发送与接收
* 信号衰减与噪声引起差错
* 接收端检测到差错
* 接收端直接纠正比特差错
* 半双工&&全双工

### 具体实现

* 接口与网卡
* 发送端
  * 封装
  * 增加差错检测比特，实现可靠数据传输和流量控制
* 接收端
  * 检测差错
  * 提取数据段

## 差错编码

### 基本原理

D->DR，R为差错检测与纠正比特

无法检测所有的差错

### 检错码&&纠错码

检测码：Hamming距离为$d_s=r+1$,可以检测r位的差错

Hamming距离：两个码字之间对应bit位的不同位数，不会导致巧合的情况

纠错码：Hamming距离为$d_s=2\times r+1$那么差错编码可以纠正r位的差错，将无效码字纠正为离他最近的有效码字

### 奇偶校验码

最后一个检测为表明1的奇偶个数，检测奇数位差错

#### 二维奇偶校验

#### Internet校验和

##### 发送端

* 划分校验内容为16位二进制数序列
* 求和
* 校验和是sum的反码

##### 接收端

* 计算checksum

#### 循环冗余校验码

* D视为二进制数

* 选择r+1比特的生成比特模式G

* 选择r位的CRC比特R满足
  * <D,R>可以被G整除
  * 接收端检错：G除<D,R>，余数为0无措
  * 小于r+1位差错都可检出
* $D\times 2^r$ XOR R 为编码结果
* R=[D*2^R/G]余数

## 多路访问控制协议

### 两类链路

* 点对点链路
* 广播链路(共享介质)
  * 无线网络
* MAC解决的是单一共享广播信道
* 两个结点同时传输，导致干扰
  * 冲突
  * 结点同时接收多个信号——接收失败
* 分布式算法决定何时共享信道
* 基于信道本身

### 理想MAC协议

* 给定：速率为R bps的广播信道
* 期望
  * case1：只有一个结点希望传输数据是，以R发送
  * case2：有M个结点期望发送数据时，每个结点平均发送数据的速率为R/M
  * 完全分散控制
    * 不用特定结点，时钟、时隙同步

### MAC协议分类

#### 信道划分MAC协议

* 多路复用，不会出现冲突
* 信道划分
* DMA协议

#### 随机访问MAC协议

* 信道不划分，允许冲突
* 冲突恢复机制

#### 轮转MAC协议

* 结点轮流使用信道

### 信道划分协议

#### TDMA

* 周期性接入信道
* 每个站点在每个周期，占用固定长度的时隙
* 导致时隙空闲

#### FDMA

* 划分为若干频带
* 每个站点分配固定的频带

适用于网络负载较重的情况

### 随机访问MAC协议

* 利用信道的全部数据速率R发送分组
* 没有实现的节点间协调
* 产生冲突

#### 定义

* 检测冲突
* 冲突重传，延迟重传

#### 典型的随机访问MAC协议

* 时隙ALOHA
* ALOHA
* CSMA,CSMA/CD,CSMA/CA

#### 时隙ALOHA协议

##### 假设

* 所有帧大小相同
* 时间被划分成等长时间槽，时间槽的长度使得如果从时隙开始时发送数据帧，时隙结束时数据帧完全发出
* 只能在时隙开始时发送数据
* 结点之前时钟同步
* 两个结点在同一时隙发送数据，结点检测到冲突

##### 运行

* 节点有新的帧事，在下一个时隙发送
  * 无冲突，则发送
  * 如果冲突，则在下一个时隙以概率p重传数据帧，直到成功

##### 优点

* 单个结点活动时，可以充分利用信道
* 分布式算法，只需要同步时隙
* 简单

##### 缺点

* 冲突，浪费时隙
* 空闲时隙但是不传输产生的数据帧(概率)
* 结点也许能以远小于分组传输时间检测到冲突

##### 效率

* 定义：长期运行时，成功发送数据真的时隙所占的比例
* N个结点发送数据帧
  * 任意节点成功发送帧的概率为$N\times p \times (1-p)^N$
  * 长期概率37%

#### ALOHA协议

* 不需要时钟同步
* 新的帧生成时
  * 立即发送
* 冲突的可能性增大
  * $t_0$发送数据，则会在$[t_0-1,t_0+1]$发生冲突
  * 与时隙ALOHA协议避损时间长
  * $p\times (1-p)^{2\times (n-1)}$

自私的协议，损人不利己

### CSMA协议

* 载波监听多路访问协议
* 发送帧之前，监听信号(载波)
  * 信道空闲，发送完整帧
  * 信道忙：推迟发送
    * 1坚持：发现信道忙一直监听信道，直到发现信道空闲
    * 非坚持：发现信道忙随即等待一段时间再次发送，不监听信道
    * P坚持：以概率p监听信道
* 冲突仍然可能发生
  * 信号传播延迟
  * 持续发送冲突帧导致信道资源浪费

#### CSMA/CD协议

* 在短时间内检测冲突
* 发现冲突传输终止

##### 冲突检测

* 有线局域网易于实现
* 无线局域网难以实现，其他信号被淹没
* 边发边听，不发不听
* 定量计算
  * 网络带宽R bps 数据帧最小长度$L_{min}$,信号传播速度V m/s，最大物理距离$d_{max}$
  * $L\div R \geq 2\times d_{max}\div V$

##### 效率

* $T_{prop}$LAN中两个节点间最大传播延迟
* $T_{Trans}$最大帧传播延迟

### 轮转访问MAC协议

#### 信道划分MAC&&随机访问MAC

##### 信道划分MAC

* 网络负载重的时候，共享信道效率高并且公平
* 网络负载轻时，共享信道效率低

##### 随机访问MAC

* 网络负载轻时，共享信道效率高，单个结点可以利用全部带宽
* 网络负载重，产生冲突开销

#### 轮询协议

* 主节点负责轮流邀请从属结点发数据
* 典型应用
  * dumb从属设备
* 问题
  * 轮询开销
  * 等待延迟
  * 单点故障，主节点故障

#### 令牌传递协议

* 控制令牌从一个结点传向下一个结点
* 获得令牌才能发送数据
* 令牌是一种特殊的数据帧
* 问题
  * 令牌开销
  * 等待延迟
  * 单点故障，环状传递：采用主节点监听

### MAC协议总结

* 信道划分：划分网络资源，平均
* 随机访问MAC协议
* 轮转访问MAC协议

## MAC地址

### 32位IP地址

* 接口的网路层地址
* 标识网络层分组

### MAC地址

* 作用：标识一个帧从哪一个接口发出，到达哪一个物理相连的其它接口
* 48位MAC地址，固化在网卡ROM中，保证在局域网内唯一‘’
* 局域网中每一块网卡MAC地址唯一
* 由IEEE统一管理和分配
* 网卡生产商购买MAC地址空间

### IP&&MAC

* mac地址可携带
* IP不可携带

### ARP地址解析协议

* 给出域名，得到IP地址
* 网络层的分组封装到链路层的数据帧需要MAC地址
* 如何从IP地址得到MAC地址

#### ARP表

* 局域网中每个IP结点维护一个
* 存储某些LAN节点的IP/MAC映射关系：<IP/MAC；TTL>
  * TTL：根据这个时间后映射关系被废弃
  * TTL后要重新获得IP/MAC
* 根据ARP表发送数据报，主机A向主机B发送数据报，给出B的IP地址
  * 在A的ARP表中查询B的MAC地址
  * 表中没有查到
    * A在局域网内广播ARP查询分组，包含B的IP地址
      * 目的MAC地址：全1
      * LAN中所有结点收到ARP查询
    * B接收到ARP查询分组，IP地址匹配成功，向A应答B的mac地址
    * 超时后，再次刷新
  * 即插即用，自主建立ARP表
  * 不在同一个局域网内。。。

#### 不在同一局域网内

通信过程：A局域网通过R路由器向B发送数据报

##### 假设

* A知道B的IP地址
* A知道R的左侧接口IP地址-默认网关
* A知道R左侧接口的MAC地址-ARP-LAN协议

##### 通信过程

* A构造IP数据报，源IP地址是A的IP地址，目的IP是B的IP地址
* A构造链路数据帧，源MAC地址是A的MAC地址，目的MAC地址是**默认网关的MAC地址**
* 帧从A发送到R
* R接收帧，提取IP数据报，传递上层IP协议(内网与互联网通信需要改IP)
* R转发IP数据报
  * R创建链路帧，转发给B，用的是B的MAC地址
* 不是直接获得B的IP地址

## 以太网

### 优点

* 造价低
* 应用广泛
* 简单便宜
* 满足网络速率需求

### 发展

* 总线网络
  * 所有结点在同一冲突域
* 星型
  * 中心交换机
  * 单独冲突域

### 特点

* 无连接
  * 发送前没有握手
* 不可靠
  * 没有确认机制
  * 差错比率较小，差错帧直接丢弃，依靠高层协议处理数据丢失
* MAC协议二进制指数CSMA/CD协议

### CSMA/CD协议

* 网卡从网络层接收数据报，创建数据帧
* 监听信道
  * if free，开始发送帧
  * if busy，等待直到信道空闲，然后发送帧
* 发送完整个帧，没有检测到其它结点数据发送，NIC确认帧发送成功
* 检测到其它结点传输数据，终止发送，发送阻塞信号
* 终止发送后，NIC进入二进制指数退避
  * m次连续冲突
    * $n=max(m,10)$
    * NIC choose a number from ${0,1,2,..,2^n-1}$ and it is k
    * wait for the time to transmit $k\times 512$ bytes data,then return to 监听
    * 连续16次冲突，不再尝试，向上层数据发送错误报告

### 以太网帧结构

* 前导码：8bytes，前7个字节10101010，最后一个字节10101011
  * 用于发送端的数据同步
* 目的mac，源mac地址，全1代表广播
  * 网卡收到的帧和目的MAC匹配则接收，或者全1则接收
  * 否则不接受
* 类型
  * 实现标记上层数据报类型，实现数据链路层的协议复用
* 数据
  * 上层载荷，出于CSMA，不能太长，最多是1500B
* 循环冗余编码

### 以太网交换机

#### 链路层设备

* 存储-转发以太网帧
* 检验到达帧的目的MAC地址，选择性向一个或多个输出链路转发帧
* CSMA/CD访问链路，发送帧

#### 透明

* 主机感知不到交换机的存在
* 即插即用，自学习
* 无需人工配置

#### 多端口同时传输

* 主机利用独享的链路直接连接交换机
* 交换机缓存帧
* 每段链路上采用CSMA/CD收发帧，没有冲突，全双工
  * 每一段链路独立的冲突域

#### 交换表

* 每个交换机有一个交换表，每个入口
  * 主机的MAC地址，到达主机的接口，时间戳
* 创建和维护交换表
  * 交换机通过自学习，得知到达主机的接口信息
  * 收到帧(包含源，目的MAC地址)，交换机学习发送帧的主机，得知其连接的交换机的端口(MAC地址)
  * 将发送主机的MAC地址、接口信息记录在交换表中

#### 交换机：帧过滤、转发

##### 交换机收到帧

* 记录帧的源MAC地址和输出链路接口(学习)
* 利用目的MAC地址检索交换表
* 检索到目的MAC地址匹配的entry
  * 如果与目的主机在同一网段，连接的是交换机同一端口
    * 丢弃帧
  * 将帧转发到对应的接口
* 没有检索到，则泛洪，转发到所有端口

##### 交换机可以互连-网络的扩展

* 自学习-泛洪
* 泛洪收到帧的目的主机应该发送一个应答帧

##### 组织机构网络

* 层次化交换机结构
* IP子网相当于一个广播域，泛洪转发

#### 交换机&&路由器

##### Similarity

* 存储，转发设备
* 转发表

#### Difference

###### 路由器

* 网络层设备-检测网络层分组首部
* 使用路由算法计算，设置转发表，依据IP地址

###### 交换机

* 链路层设备-检测链路层帧的首部
* 利用自学习，泛洪构建转发表，依据MAC地址

直通传输-边收边发

## VLANs

分隔子网-路由器

限制广播域：隐私，流量控制

### 虚拟局域网(Virtual local Area Network)

可以在一个LAN架构上配置、定义多个VLAN

* 基于端口的VLAN:分组交换机端口
  * 流量隔离
* 基于主机的MAC地址划分
  * 动态成员，不用被物理链路限制

#### VLAN之间通信

* 使用路由器，实际上路由器和交换机被集成为一个设备

#### 跨越多个物理交换机的VLAN

* 多条线缆连接
* 中继端口：跨越多个物理交换机定义VLAN承载帧
  * 携带VLAN ID信息
  * 802.1qVLAN帧，插入4byte的标记字段
    * 2 byte标记协议ID x8100
    * 2 btye标记控制信息,VLAN ID

## PPP协议

* 面向点对点数据链路控制
* 全双工
* 无需MAC协议和MAC寻址
* 常见的点对点数据链路控制协议
  * HDLC
  * PPP(Point to Point)

### 设计需求

* 组帧：将网络层数据报封装到链路层帧中
  * 可以同时成在任何网络层协议分组，不仅IP数据报
  * 多个网络协议，必须实现多路分解
* 比特透明传输：承载任何比特模式，对于任何网络层数据
* 差错检测，不纠正
* 连接活性检测，检测链路失效
* 网络层地址协商，端节点可以学习/配置彼此网络地址
* 差错恢复和流量控制由上级协议完成

### 数据帧格式

* 标志FLAG：帧定界符
* 地址：无意义，全取1
* 控制：无效
* 协议：1个字节或2个字节，上层协议，长度可协商
* 信息：封装上层协议分组
* 校验
* 标志

### 字节填充

* 目的：允许数据域包含01111110
* 发送端在01111110和01111101字节前添加额外的字节01111101
* 接收端需要判断填充字节

### 数据控制协议，建立PPP链路

* 配置PPP链路
  * 协商：最大帧长，身份认证，帧的格式
* 学习、配置网络层信息
  * 根据上层网络层协议配置
  * IP协议，交换IPCP报文，配置两端IP地址

## 802.11无线局域网

### 802.11b

* 使用免费频段
* 最高速率11Mbps
* 物理层直接序列扩频技术
  * 所有用户使用相同的码片序列

### 体系结构

* 基站：访问点
* 基站覆盖范围：基本服务级
  * 无限主机
  * 基站

### 信道与AP关联

2.4GHz-2.485GHz划分成11个不同频率的信道

* 每个AP选择一个频率
* 存在干扰，相邻的AP选择相同的信道
* 主机与某个AP关联
  * 主机扫描所有信道，监听包含AP名称(服务集标识符)和MAC地址的信标帧-由服务主机定时发出
  * 选择AP进行关联
  * 可能需要身份认证
  * 运行DHCP获取IP地址信息

#### 关联

* 被动扫描
  * 各个AP发送信标帧
  * 主机向选择的AP发送关联请求帧
  * AP向主机发送关联响应帧(通过身份认证)
* 主动扫描
  * 主动广播探测请求帧
  * 接收到的AP发送探测响应帧
  * 主机向选择的AP发送关联请求帧
  * AP向主机发送关联响应帧

### 多路访问控制

避免冲突

CSMA：监听信道，避免与正在传输的其它结点冲突

**不能边发送，边检测，因为信号衰减强**，存在隐藏站

目标：避免冲突CSMA/CA

#### 数据发送方

* 信道空闲，并不立即发送数据
  * 空闲了DIFS时间，才发送整个帧
* 监听到信道忙
  * 随机退避算法
  * 倒计时，直到信道空闲
* 发送完成，需要ACK确认收到
  * 没收到ACK需要随机退避

#### 数据接收方

* 延迟SIFS时间，发送ACK

#### 冲突避免机制

* 基本思想：避免数据帧冲突，导致信道浪费
* 发送端预约信道

##### 发送方

* 发送方向BS发送一个很短的RTS
  * RTS冲突代价小
* BS广播CTS帧响应RTS，发生冲突则不发送RTS
* 消除隐藏站

### 帧结构

* 地址字段有四个
  * 地址1，目的地址，AP地址
  * 地址2：AP地址，源地址
  * 地址3：源地址，目的地址

* duration：预约信道占用时间

* 帧序号：可靠数据传输，分片

* 帧控制